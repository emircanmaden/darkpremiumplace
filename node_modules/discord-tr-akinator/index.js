const Discord = require("discord.js");
const { Aki } = require("aki-api");
const games = new Set();

/**
    * @param {Discord.Message} message The Message Sent by the User.
    * @returns Discord.js Akinator Game
    * @async
    * @example
    *  const akinator = require("discord.js-akinator");
    * 
    * const PREFIX = "!";
    * 
    * client.on("message", async message => {
    *     if(message.content.startsWith(`${PREFIX}akinator`)) {
    *         akinator(message)
    *     }
    * });
       */

module.exports = async function (message) {

    if (!message) return console.log("Türkçe Akinator Başlatıldı");
    if (games.has(message.author.id)) {
        let alreadyPlayingEmbed = new Discord.MessageEmbed()
            .setAuthor(`${message.author.username}#${message.author.discriminator}`, message.author.displayAvatarURL())
            .setTitle(`❌ Zaten Oynuyorsun!`)
            .setDescription("**Zaten bir Akinator Oyunu Oynuyorsunuz. Oyununuzu İptal Etmek için 'Durdur' yazın.**")
            .setColor("RED")

        return message.channel.send({ embed: alreadyPlayingEmbed })
    }
    games.add(message.author.id)

    let startingEmbed = new Discord.MessageEmbed()
        .setAuthor(`${message.author.username}#${message.author.discriminator}`, message.author.displayAvatarURL())
        .setTitle(`Oyun başlıyor...`)
        .setDescription("**Oyun Yaklaşık 3 Saniye İçinde Başlayacak...**")
        .setColor("RANDOM")

    let startingMessage = await message.channel.send({ embed: startingEmbed })

    let aki = new Aki("tr")
    await aki.start();

    let notFinished = true;
    let stepsSinceLastGuess = 0;

    let noResEmbed = new Discord.MessageEmbed()
        .setAuthor(`${message.author.username}#${message.author.discriminator}`, message.author.displayAvatarURL())
        .setTitle(`Oyun Bitti`)
        .setDescription(`**${message.author.username}, 1 Dakika Hareketsizlik Kalman Nedeniyle Oyununuz Sona Erdi.**`)
        .setColor("RANDOM")

    let akiEmbed = new Discord.MessageEmbed()
        .setAuthor(`${message.author.username}#${message.author.discriminator}`, message.author.displayAvatarURL())
        .setTitle(`Soru ${aki.currentStep + 1}`)
        .setDescription(`**İlerleme: 0%\n${aki.question}**`)
        .addField("Lütfen yazın...", "**evet**\n**hayır**\n**bilmiyorum**\n**muhtemelen**\n**muhtemelen değil**\n**geri**")
        .setFooter(`Oyununuzu Sonlandırmak "durdur" yazabilirsiniz.`)
        .setColor("RANDOM")

    await startingMessage.delete();
    let akiMessage = await message.channel.send({ embed: akiEmbed });

    while (notFinished) {
        if (!notFinished) return;

        stepsSinceLastGuess = stepsSinceLastGuess + 1

        if ((aki.progress >= 95 && stepsSinceLastGuess >= 10) || aki.currentStep >= 78) {
            await aki.win();

            stepsSinceLastGuess = 0;

            let guessEmbed = new Discord.MessageEmbed()
                .setAuthor(`${message.author.username}#${message.author.discriminator}`, message.author.displayAvatarURL())
                .setTitle(`${Math.round(aki.progress)}% Karakterinizin olduğundan emin olun...`)
                .setDescription(`**${aki.answers[0].name}**\n${aki.answers[0].description}\n\nBu senin karakterin mi? **(sEÇİM: evet | hayır)**`)
                .addField("Sıralama", `**#${aki.answers[0].ranking}**`, true)
                .addField("Soru Sayısı", `**${aki.currentStep}**`, true)
                .setImage(aki.answers[0].absolute_picture_path)
                .setColor("RANDOM")
            await akiMessage.edit({ embed: guessEmbed });

            const guessFilter = x => {
                return (x.author.id === message.author.id && ([
                    "y",
                    "evet",
                    "n",
                    "hayır"
                ].includes(x.content.toLowerCase())));
            }

            await message.channel.awaitMessages(guessFilter, {
                max: 1, time: 60000
            })
                .then(async responses => {
                    if (!responses.size) {
                        return akiMessage.edit({ embed: noResEmbed });
                    }
                    const guessAnswer = String(responses.first()).toLowerCase();

                    await responses.first().delete();

                    if (guessAnswer == "y" || guessAnswer == "evet") {
                        let finishedGameCorrect = new Discord.MessageEmbed()
                            .setAuthor(`${message.author.username}#${message.author.discriminator}`, message.author.displayAvatarURL())
                            .setTitle(`Güzel oynadı!`)
                            .setDescription(`**${message.author.username}, Bir kez daha doğru tahmin ettim!**`)
                            .addField("Karakter", `**${aki.answers[0].name}**`, true)
                            .addField("Sıralama", `**#${aki.answers[0].ranking}**`, true)
                            .addField("Soru Sayısı", `**${aki.currentStep}**`, true)
                            .setColor("RANDOM")
                        await akiMessage.edit({ embed: finishedGameCorrect })
                        notFinished = false;
                        games.delete(message.author.id)
                        return;
                    } else if (guessAnswer == "n" || guessAnswer == "hayır") {
                        if (aki.currentStep >= 78) {
                            let finishedGameDefeated = new Discord.MessageEmbed()
                                .setAuthor(`${message.author.username}#${message.author.discriminator}`, message.author.displayAvatarURL())
                                .setTitle(`Güzel oynadı!`)
                                .setDescription(`**${message.author.username}, Bravo! Beni yendin...**`)
                                .setColor("RANDOM")
                            await akiMessage.edit({ embed: finishedGameDefeated })
                            notFinished = false;
                            games.delete(message.author.id)
                        } else {
                            let loadingEmbed = new Discord.MessageEmbed()
                                .setAuthor(`${message.author.username}#${message.author.discriminator}`, message.author.displayAvatarURL())
                                .setTitle(`I'm ${Math.round(aki.progress)}% Karakterinizin olduğundan emin olun...`)
                                .setDescription(`**${aki.answers[0].name}**\n${aki.answers[0].description}\n\nIs bu senin karakterin mi? **(Seç: evet | hayır)**`)
                                .addField("Sıralama", `**#${aki.answers[0].ranking}**`, true)
                                .addField("Soru Sayısı", `**${aki.currentStep}**`, true)
                                .setImage(aki.answers[0].absolute_picture_path)
                                .setColor("RANDOM")
                            await akiMessage.edit({ embed: loadingEmbed });
                            aki.progress = 50
                        }
                    }
                });
        }

        if (!notFinished) return;

        const filter = x => {
            return (x.author.id === message.author.id && ([
                "y",
                "evet",
                "n",
                "hayır",
                "idk",
                "bilmiyorum",
                "don't know",
                "p",
                "muhtemelen",
                "pn",
                "muhtemelen değil",
                "b",
                "geri",
                "s",
                "durdur"
            ].includes(x.content.toLowerCase())));
        }

        await message.channel.awaitMessages(filter, {
            max: 1, time: 60000
        })
            .then(async responses => {
                if (!responses.size) {
                    await aki.win()
                    notFinished = false;
                    games.delete(message.author.id)
                    return akiMessage.edit({ embed: noResEmbed })
                }
                const answer = String(responses.first()).toLowerCase().replace("'", "");

                const answers = {
                    "y": 0,
                    "evet": 0,
                    "n": 1,
                    "hayır": 1,
                    "idk": 2,
                    "bilmiyorum": 2,
                    "p": 3,
                    "muhtemelen": 3,
                    "pn": 4,
                    "muhtemelen değil": 4,
                }

                let thinkingEmbed = new Discord.MessageEmbed()
                    .setAuthor(`${message.author.username}#${message.author.discriminator}`, message.author.displayAvatarURL())
                    .setTitle(`Soru ${aki.currentStep + 1}`)
                    .setDescription(`**İlerleme: ${Math.round(aki.progress)}%\n${aki.question}**`)
                    .addField("Lütfen yazın...", "**evet**\n**hayır**\n**bilmiyorum**\n**muhtemelen**\n**muhtemelen değil**\n**geri**")
                    .setFooter(`Düşünüyorum...`)
                    .setColor("RANDOM")
                await akiMessage.edit({ embed: thinkingEmbed })

                await responses.first().delete();

                if (answer == "b" || answer == "geri") {
                    if (aki.currentStep >= 1) {
                        await aki.back();
                    }
                } else if (answer == "s" || answer == "durdur") {
                    games.delete(message.author.id)
                    let stopEmbed = new Discord.MessageEmbed()
                        .setAuthor(`${message.author.username}#${message.author.discriminator}`, message.author.displayAvatarURL())
                        .setTitle(`Oyun Bitti`)
                        .setDescription(`**${message.author.username}, oyunun başarıyla sona erdi!**`)
                        .setColor("RANDOM")
                    await aki.win()
                    await akiMessage.edit({ embed: stopEmbed })
                    notFinished = false;
                } else {
                    await aki.step(answers[answer]);
                }

                if (!notFinished) return;

                let updatedAkiEmbed = new Discord.MessageEmbed()
                    .setAuthor(`${message.author.username}#${message.author.discriminator}`, message.author.displayAvatarURL())
                    .setTitle(`Soru ${aki.currentStep + 1}`)
                    .setDescription(`**İlerleme: ${Math.round(aki.progress)}%\n${aki.question}**`)
                    .addField("Lütfen Seçin...", "**evet**\n**hayır**\n**bilmiyorum**\n**muhtemelen**\n**muhtemelen değil**\n**geri**")
                    .setFooter(`Oyununuzu Sonlandırmak için "durdur" yazabilirsiniz.`)
                    .setColor("RANDOM")
                akiMessage.edit({ embed: updatedAkiEmbed })
            });
    }
}